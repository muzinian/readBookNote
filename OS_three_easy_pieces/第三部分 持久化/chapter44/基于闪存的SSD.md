## 基于闪存的SSD
在硬盘驱动主宰了数十年后，一种新型持久化存储设备最近在世界范围取得了重要意义。通常称它为 __固态硬盘(solid-state storage)__，这种设备不像硬盘那样有机械或者移动部分；它们是有晶体管(transistors)构建的，很像内存和处理器。然而，不像典型的随机访问内存(例如，DRAM)，这样一个 __固态存储设备(solid-state storage device)__(也即，__SSD__)在掉电时也会保持数据，从而是数据持久化设备的理想候选。

我们要关注的技术是 __闪存(flash)__(更具体的，__NAND闪存(NAND-based flash)__)，由舛冈富士雄20世纪80年代发明。我们将看到闪存有很多独特的性质。例如，为了在它的一个chunk中写入数据(例如，一个 __闪存页(flash page)__)，你先不得不擦除更大的chunk(例如，__闪存block(flash block)__)，这就很昂贵了。另外，对一个页写入太多次会导致 __耗尽(wear out)__。这两个性质就让制造闪存SSD有了新的挑战：
>#### 症结：如何构建闪存SSD
>我们要怎样才能构建闪存SSD？我们如何处理擦除这一昂贵特性？我们要怎样构建一个可用时间很久的设备，即使重复覆写回到是设备耗尽？技术进步的比赛会停止么？或者会停止在不再让人惊喜？
### 44.1 存储单个bit
闪存芯片设计为在单个晶体管可以存储一到多个bits；晶体管束缚的电荷水平 (the level of charge trapped within the transistor is mapped to binary value)被映射到二进制值(the level of charge trapped within the transistor is mapped to binary value)。在 __单层cell(single-level cell SLC)__ 闪存，一个晶体管只存储一个bit(1或者0)；而在 __多级cell(multi-level cell MLC)__ 闪存中，两位被编码为不同的电荷水平，例如，00，01，10和11分别代表，低，稍微低，稍微高和高水平。甚至还有 __三层cell(triple-level cell TLC)__ 闪存，在每个cell中编码了三个位。总之，SLC芯片性能更高但是也更贵。

当然，对于这种位级别存储是如何操作的还有很多细节，这就到了设备物理性质的层级了。这超出了本书的范围，你可以自己查阅相关资料。

### 44.2 从bit到bank/Planes
就想古希腊人说的那样，存储单个bit(或者几个bit)不是一个存储系统。因此，闪存芯片被组织为 __banks__ 或者 __planes__，包含了大量的cell。

一个bank按照两种不同尺寸单元的方式访问：__blocks__(有时候也叫做 __擦除block(earse block)__)，典型的尺寸是128KB或者256KB，和 __pages__，大小只有几KB(例如，4KB)。当考虑闪存时，你必须要记住这些新术语，这和我们在硬盘以及RAID中提到的block，我们在虚拟内存中提到page是不一样的。

>#### tip:对术语要仔细
>你可能注意到了我们在闪存这个上下文中使用的一些术语在之前被使用过很多次(例如blocks，pages)，但是和之前有些许的差别。没有创建新词语从而让你的生活更难(尽管它们可能会这样做)，但是却出现了没有术语决定权的权威机构。对你来说block可能是一个page，但是对别人可能是别的东西，反之亦然，这依赖于上下文。你的工作很简单：了解每个领域中合适的术语，使用它们这样熟悉这个领域的人(people well-versed in the discipline)就可以理解你在讨论什么。这就是那种时刻，唯一的方法很简单，但是痛苦：使用你的记忆力。

图44_1显示了一个包含了blocks和pages的闪存plane；在这个简单的例子中，有三个blocks，每个都包含4个pages。下面我们会看到为什么要区分blocks和pages；事实证明中各种区别对于闪存操作，例如读写，是很关键的，甚至对设备整体的性能更加关键。你将学到最重要(且奇怪)的事情是为了在一个block中写入一个page，你首先不得不擦除整个block；这个诡异的细节让构建一个闪存SSD成为了一个很有意思值得花费时间的挑战，这是本章第二部分的主题：

![figure44_1.png "一个简单的Flash芯片：包含pages的blocks"](figure44_1.png "一个简单的Flash芯片：包含pages的blocks")

### 44.3 闪存基本操作
由于flash的组织形式，flash芯片支持三个底层操作。__读__ 命令用来从闪存中读取一个page，__擦除(erase)__ 和 __编程(program)__ 合起来完成写。细节如下：
* __读(一个page)：__ 闪存芯片客户可以读取任意page(例如，2KB或者4KB)，只需要想设备指定读命令和合适的page号(page number)。这个操作很快，大约10几微秒，与期在设备上的位置无关，也(多少)和之前请求位置无关(和硬盘很不像)。访问任何位置都一样快意味着设备是一个 __随机访问(random access)__ 设备。
* __擦除(一个block)：__ 再闪存中写入一个 _page_ 前，设备的特点要求你首先要 __擦除(erase)__ page所在的整个block。擦除，重要的是，毁坏block的内容(通过设置每个bit的值为1)；因此，你必须保证在这个block中的你关心的任何数据在执行擦除前已被复制到其它地方了(内存，或者另一个闪存block)。擦除命令很费时间，大概几毫秒才能完成。一旦结束，整个block被重置每个页都准备好被编程了。
* __编程(一个页)：__ 一旦一个block被擦除了，编程命令可以用来修改page内某些1为0，从而写入想要的一个page内容到闪存中。编程一个page比擦除一个block开销少，但是比读取一个page开销多很多，在现代闪存芯片上通常花费100多微妙。

